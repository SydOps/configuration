{
	"AWSTemplateFormatVersion":"2010-09-09",
	"Description":"Twitter Feed production environment",
	"Parameters":{
		"WebServerPort":{
			"Description":"Port that the application will run on",
			"Type":"String",
			"Default":"8080"
		},
		"KeyName":{
			"Description":"Name of an existing EC2 KeyPair to enable SSH access to the instances",
			"Type":"String"
		},
		"ImageId":{
			"Description":"The image holding the application code",
			"Type":"String"
		}
	},
	"Resources":{
		"WebServerGroup":{
			"Type":"AWS::AutoScaling::AutoScalingGroup",
			"Properties":{
				"AvailabilityZones":{
					"Fn::GetAZs":""
				},
				"LaunchConfigurationName":{
					"Ref":"LaunchConfig"
				},
				"MinSize":"2",
				"MaxSize":"2",
				"LoadBalancerNames":[
					{
						"Ref":"ElasticLoadBalancer"
					}
				]
			}
		},
		"LaunchConfig":{
			"Type":"AWS::AutoScaling::LaunchConfiguration",
			"Properties":{
				"KeyName":{
					"Ref":"KeyName"
				},
				"ImageId":{
          "Ref":"ImageId"
        },
				"SecurityGroups":[
					{
						"Ref":"ProductionSecurityGroup"
					}
				],
				"InstanceType":"m1.medium"
			}
		},
		"ElasticLoadBalancer":{
			"Type":"AWS::ElasticLoadBalancing::LoadBalancer",
			"Properties":{
				"AvailabilityZones":{
					"Fn::GetAZs":""
				},
				"Listeners":[
					{
						"LoadBalancerPort":"80",
						"InstancePort":{
							"Ref":"WebServerPort"
						},
						"Protocol":"HTTP"
					}
				],
				"HealthCheck":{
					"Target":{
						"Fn::Join":[
							"",
							[
								"HTTP:",
								{
									"Ref":"WebServerPort"
								},
								"/"
							]
						]
					},
					"HealthyThreshold":"3",
					"UnhealthyThreshold":"5",
					"Interval":"30",
					"Timeout":"5"
				}
			}
		},
		"ProductionSecurityGroup":{
			"Type":"AWS::EC2::SecurityGroup",
			"Properties":{
				"GroupDescription":"Enable SSH access and HTTP access on the configured port",
				"SecurityGroupIngress":[
					{
						"IpProtocol":"tcp",
						"FromPort":"22",
						"ToPort":"22",
						"CidrIp":"0.0.0.0/0"
					},
					{
						"IpProtocol":"tcp",
						"FromPort":{
							"Ref":"WebServerPort"
						},
						"ToPort":{
							"Ref":"WebServerPort"
						},
						"CidrIp":"0.0.0.0/0"
					}
				]
			}
		}
	},
	"Outputs":{
		"URL":{
			"Description":"URL of the website",
			"Value":{
				"Fn::Join":[
					"",
					[
						"http://",
						{
							"Fn::GetAtt":[
								"ElasticLoadBalancer",
								"DNSName"
							]
						}
					]
				]
			}
		}
	}
}
